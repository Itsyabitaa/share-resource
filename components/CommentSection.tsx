import { useState, useEffect } from 'react'\nimport { useTheme } from '../lib/ThemeContext'\nimport { useRouter } from 'next/router'\n\ninterface Comment { \n  id: string\n  user_id: string\n  content: string\n  created_at: string\n } \n\ninterface CommentSectionProps { \n  fileId: string\n  isAuthenticated: boolean\n  currentUserId ?: string\n } \n\nexport default function CommentSection({ fileId, isAuthenticated, currentUserId }: CommentSectionProps) { \n  const [comments, setComments] = useState<Comment[]>([]) \n  const [newComment, setNewComment] = useState('') \n  const [isLoading, setIsLoading] = useState(true) \n  const [isSubmitting, setIsSubmitting] = useState(false) \n  const { colors } = useTheme() \n  const router = useRouter() \n\n  useEffect(() => { \n    loadComments() \n }, [fileId]) \n\n  const loadComments = async () => { \n    try { \n      const response = await fetch(`/api/comments?fileId=${fileId}`) \n      if (response.ok) { \n        const data = await response.json() \n        setComments(data.comments || []) \n } \n } catch (error) { \n      console.error('Error loading comments:', error) \n } finally { \n      setIsLoading(false) \n } \n }\n\n  const handleSubmit = async (e: React.FormEvent) => { \n    e.preventDefault() \n    \n    if (!isAuthenticated) { \n      router.push('/login?redirect=' + encodeURIComponent(router.asPath)) \n      return \n } \n\n    if (!newComment.trim() || isSubmitting) return \n\n    setIsSubmitting(true) \n    try { \n      const response = await fetch('/api/comments', { \n        method: 'POST', \n        headers: { 'Content-Type': 'application/json' }, \n        body: JSON.stringify({ fileId, content: newComment.trim() }) \n }) \n\n      if (response.ok) { \n        const data = await response.json() \n        setComments([data.comment, ...comments]) \n        setNewComment('') \n } else { \n        const error = await response.json() \n        alert(error.error || 'Failed to add comment') \n } \n } catch (error) { \n      console.error('Error adding comment:', error) \n      alert('Failed to add comment') \n } finally { \n      setIsSubmitting(false) \n } \n }\n\n  const handleDelete = async (commentId: string) => { \n    if (!confirm('Are you sure you want to delete this comment?')) return \n\n    try { \n      const response = await fetch(`/api/comments?id=${commentId}`, { \n        method: 'DELETE'\n }) \n\n      if (response.ok) { \n        setComments(comments.filter(c => c.id !== commentId)) \n } else { \n        const error = await response.json() \n        alert(error.error || 'Failed to delete comment') \n } \n } catch (error) { \n      console.error('Error deleting comment:', error) \n      alert('Failed to delete comment') \n } \n }\n\n  const formatDate = (dateString: string) => { \n    const date = new Date(dateString) \n    const now = new Date() \n    const diffMs = now.getTime() - date.getTime() \n    const diffMins = Math.floor(diffMs / 60000) \n    const diffHours = Math.floor(diffMins / 60) \n    const diffDays = Math.floor(diffHours / 24) \n\n    if (diffMins < 1) return 'Just now'\n    if (diffMins < 60) return `${diffMins}m ago`\n    if (diffHours < 24) return `${diffHours}h ago`\n    if (diffDays < 7) return `${diffDays}d ago`\n    return date.toLocaleDateString() \n }\n\n  return (\n < div style = {{ marginTop: '30px' } }>\n < h3 style = {{ \n        marginBottom: '20px', \n        fontSize: '1.3rem', \n        color: colors.text\n }}>\n        üí¨ Comments({ comments.length }) \n      </h3 >\n\n      {/* Comment Form */ } \n      { isAuthenticated ? (\n < form onSubmit = { handleSubmit } style = {{ marginBottom: '30px' } }>\n < textarea\n            value = { newComment }\n            onChange = {(e) => setNewComment(e.target.value)}\n            placeholder =\"Write a comment...\"\n            maxLength={1000}\n            rows={3}\n            style={{\n              width: '100%',\n              padding: '12px',\n              fontSize: '14px',\n              border: `1px solid ${colors.border}`,\n              borderRadius: '8px',\n              backgroundColor: colors.inputBackground,\n              color: colors.text,\n              resize: 'vertical',\n              fontFamily: 'inherit',\n              outline: 'none'\n            }}\n            onFocus={(e) => {\n              e.target.style.borderColor = colors.primary\n            }}\n            onBlur={(e) => {\n              e.target.style.borderColor = colors.border\n            }}\n          />\n          <div style={{ \n            display: 'flex', \n            justifyContent: 'space-between',\n            alignItems: 'center',\n            marginTop: '10px'\n          }}>\n            <span style={{ \n              fontSize: '12px', \n              color: colors.secondary \n            }}>\n              {newComment.length}/1000\n            </span>\n            <button\n              type=\"submit\"\n              disabled={!newComment.trim() || isSubmitting}\n              style={{\n                padding: '8px 20px',\n                backgroundColor: newComment.trim() ? colors.buttonBackground : colors.border,\n                color: newComment.trim() ? colors.buttonText : colors.secondary,\n                border: 'none',\n                borderRadius: '6px',\n                cursor: newComment.trim() && !isSubmitting ? 'pointer' : 'not-allowed',\n                fontSize: '14px',\n                fontWeight: '500',\n                transition: 'all 0.2s ease'\n              }}\n            >\n              {isSubmitting ? 'Posting...' : 'Post Comment'}\n            </button>\n          </div>\n        </form>\n      ) : (\n        <div style={{\n          padding: '20px',\n          backgroundColor: colors.inputBackground,\n          borderRadius: '8px',\n          border: `1px solid ${colors.border}`,\n          textAlign: 'center',\n          marginBottom: '30px'\n        }}>\n          <p style={{ color: colors.secondary, marginBottom: '10px' }}>\n            Please login to comment\n          </p>\n          <button\n            onClick={() => router.push('/login?redirect=' + encodeURIComponent(router.asPath))}\n            style={{\n              padding: '8px 20px',\n              backgroundColor: colors.buttonBackground,\n              color: colors.buttonText,\n              border: 'none',\n              borderRadius: '6px',\n              cursor: 'pointer',\n              fontSize: '14px',\n              fontWeight: '500'\n            }}\n          >\n            Login\n          </button>\n        </div>\n      )}\n\n      {/* Comments List */}\n      {isLoading ? (\n        <div style={{ textAlign: 'center', padding: '20px', color: colors.secondary }}>\n          Loading comments...\n        </div>\n      ) : comments.length === 0 ? (\n        <div style={{ textAlign: 'center', padding: '20px', color: colors.secondary }}>\n          No comments yet. Be the first to comment!\n        </div>\n      ) : (\n        <div style={{ display: 'flex', flexDirection: 'column', gap: '15px' }}>\n          {comments.map((comment) => (\n            <div\n              key={comment.id}\n              style={{\n                padding: '15px',\n                backgroundColor: colors.inputBackground,\n                borderRadius: '8px',\n                border: `1px solid ${colors.border}`\n              }}\n            >\n              <div style={{ \n                display: 'flex', \n                justifyContent: 'space-between',\n                alignItems: 'flex-start',\n                marginBottom: '10px'\n              }}>\n                <div style={{ flex: 1 }}>\n                  <div style={{ \n                    fontSize: '12px', \n                    color: colors.secondary,\n                    marginBottom: '5px'\n                  }}>\n                    {formatDate(comment.created_at)}\n                  </div>\n                  <div style={{ \n                    fontSize: '14px', \n                    color: colors.text,\n                    lineHeight: '1.5',\n                    whiteSpace: 'pre-wrap'\n                  }}>\n                    {comment.content}\n                  </div>\n                </div>\n                {currentUserId === comment.user_id && (\n                  <button\n                    onClick={() => handleDelete(comment.id)}\n                    style={{\n                      padding: '4px 8px',\n                      backgroundColor: 'transparent',\n                      color: '#ef4444',\n                      border: 'none',\n                      borderRadius: '4px',\n                      cursor: 'pointer',\n                      fontSize: '12px',\n                      marginLeft: '10px'\n                    }}\n                    onMouseEnter={(e) => {\n                      e.currentTarget.style.backgroundColor = 'rgba(239, 68, 68, 0.1)'\n                    }}\n                    onMouseLeave={(e) => {\n                      e.currentTarget.style.backgroundColor = 'transparent'\n                    }}\n                    title=\"Delete comment\"\n                  >\n                    üóëÔ∏è Delete\n                  </button>\n                )}\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  )\n}\n
